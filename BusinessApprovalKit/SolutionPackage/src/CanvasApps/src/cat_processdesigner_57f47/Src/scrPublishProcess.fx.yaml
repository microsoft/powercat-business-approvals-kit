scrPublishProcess As screen:
    LoadingSpinnerColor: =RGBA(0, 120, 212, 1)
    OnVisible: |+
        =//check last published version
        With({ 
            publishedVersions: 
                SortByColumns(
                    Filter('Business Approval Versions', Process.'Business Approval Process' = _selectedProcess.'Business Approval Process'),
                    "cat_version", SortOrder.Descending
                )
            },
            UpdateContext({ isPublishReady: false, lastPublished: First(publishedVersions) })
        );
        
        //validate process stages
        Clear(_emptyNodes);
        If(IsEmpty(_validationChecks),
            ClearCollect(_validationChecks,
                { Id: 1, Check: "First approval stage must not have any condition", Status: Blank(), Details: ""},
                { Id: 2, Check: "First node in first stage must not have any condition", Status: Blank(), Details: ""},
                { Id: 3, Check: "Approval stage must have at least one Node", Status: Blank(), Details: ""},
                { Id: 4, Check: "No stage is inaccessible", Status: true, Details: "" }
            )
        );
        
        UpdateContext({ firstStage: 
            First(SortByColumns(
                Filter('Business Approval Stages', Process.'Business Approval Process' = _selectedProcess.'Business Approval Process'),
                "cat_order", SortOrder.Ascending
            ))}
        );
        
        //check condition 1
        UpdateIf(_validationChecks, Id = 1, 
            { Status: CountRows(Filter('Business Approval Conditions', Stage.'Business Approval Stage' = firstStage.'Business Approval Stage')) = 0 }
        );
        
        //check condition 2
        With({ firstNode: 
            First(
                SortByColumns(
                    Filter('Business Approval Nodes', Stage.'Business Approval Stage' = firstStage.'Business Approval Stage'),
                    "cat_rowindex", SortOrder.Ascending)
            )},
            UpdateIf(_validationChecks, Id = 2, 
                With({ firstNodeId: firstNode.'Business Approval Node'},
                { 
                    Status: CountRows(Filter('Business Approval Conditions', Node.'Business Approval Node' = firstNodeId)) = 0             
                })
            )
        );
        
        //check condition 3
        ForAll(_selectedProcess.'Business Approval Stages' As valStages, 
            Collect(_emptyNodes, 
                CountRows(Filter('Business Approval Nodes', Stage.'Business Approval Stage' = valStages.'Business Approval Stage')) > 0
            )
        );
        UpdateIf(_validationChecks, Id = 3, { Status: CountIf(_emptyNodes, Value = false) = 0 });
        UpdateContext({ isPublishReady: true })
        

    Container1_10 As groupContainer:
        Height: =Parent.Height - Self.Y
        Width: =Parent.Width - Self.X
        ZIndex: =1

        Gallery4 As gallery.galleryVertical:
            '#CopilotOverlayLabel': ="Filtered"
            BorderColor: =RGBA(166, 166, 166, 1)
            DelayItemLoading: =true
            FocusedBorderThickness: =2
            Height: =CountRows(Self.AllItems) * (Self.TemplateHeight + 2 * Self.TemplatePadding)
            Items: =_validationChecks
            Layout: =Layout.Vertical
            LoadingSpinner: =LoadingSpinner.Data
            TemplateSize: =40
            Width: =Parent.Width - Self.X
            Y: =Label6.Height
            ZIndex: =1

            Label5 As label:
                BorderColor: =RGBA(0, 0, 0, 0)
                BorderStyle: =BorderStyle.None
                BorderThickness: =2
                Color: =RGBA(51, 51, 51, 1)
                DisabledBorderColor: =RGBA(0, 0, 0, 0)
                DisabledColor: =RGBA(166, 166, 166, 1)
                FocusedBorderThickness: =4
                Font: =Font.'Segoe UI'
                Height: =Parent.TemplateHeight
                OnSelect: =Select(Parent)
                PaddingLeft: =12
                Size: =10
                Text: =ThisItem.Check
                Width: =Parent.Width / 2
                X: =Image3.Width
                ZIndex: =1

            Image3 As image:
                BorderColor: =RGBA(0, 0, 0, 0)
                BorderStyle: =BorderStyle.None
                BorderThickness: =2
                DisabledBorderColor: =RGBA(0, 0, 0, 0)
                DisabledFill: =RGBA(0, 0, 0, 0)
                FocusedBorderThickness: =4
                Height: =30
                HoverBorderColor: =RGBA(0, 0, 0, 0)
                HoverFill: =RGBA(0, 0, 0, 0)
                Image: ='25_black'
                OnSelect: =Select(Parent)
                PressedBorderColor: =RGBA(0, 0, 0, 0)
                PressedFill: =RGBA(0, 0, 0, 0)
                Visible: =IsBlank(ThisItem.Status)
                Width: =30
                Y: =Parent.TemplateHeight / 2 - Self.Height / 2
                ZIndex: =2

            Icon4 As icon.CheckBadge:
                BorderColor: =RGBA(166, 166, 166, 1)
                Color: =If(Self.Icon = Icon.CheckBadge, Color.Green, Color.Red)
                DisabledBorderColor: =RGBA(0, 0, 0, 0)
                DisabledColor: =RGBA(220, 220, 220, 1)
                DisabledFill: =RGBA(0, 0, 0, 0)
                FocusedBorderThickness: =4
                Height: =30
                HoverBorderColor: =RGBA(0, 0, 0, 0)
                HoverColor: =ColorFade(RGBA(105, 121, 126, 1), -30%)
                HoverFill: =RGBA(0, 0, 0, 0)
                Icon: =If(ThisItem.Status, Icon.CheckBadge, Icon.CancelBadge)
                OnSelect: =Select(Parent)
                PaddingBottom: =5
                PaddingLeft: =5
                PaddingRight: =5
                PaddingTop: =5
                PressedBorderColor: =RGBA(0, 0, 0, 0)
                PressedColor: =ColorFade(RGBA(105, 121, 126, 1), -30%)
                PressedFill: =RGBA(0, 0, 0, 0)
                Visible: =!Image3.Visible
                Width: =30
                X: =Image3.X
                Y: =Image3.Y
                ZIndex: =3

            Rectangle4 As rectangle:
                BorderColor: =RGBA(0, 0, 0, 0)
                BorderStyle: =BorderStyle.None
                BorderThickness: =2
                DisabledFill: =RGBA(166, 166, 166, 1)
                Fill: =RGBA(105, 121, 126, 1)
                FocusedBorderThickness: =4
                Height: =1
                HoverFill: =RGBA(105, 121, 126, 1)
                OnSelect: =Select(Parent)
                PressedFill: =RGBA(105, 121, 126, 1)
                Width: =Parent.TemplateWidth - 5
                Y: =Parent.TemplateHeight - 1
                ZIndex: =4

        Label6 As label:
            BorderColor: =RGBA(0, 0, 0, 0)
            BorderStyle: =BorderStyle.None
            BorderThickness: =2
            Color: =RGBA(51, 51, 51, 1)
            DisabledBorderColor: =RGBA(0, 0, 0, 0)
            DisabledColor: =RGBA(166, 166, 166, 1)
            FocusedBorderThickness: =4
            Font: =Font.'Segoe UI'
            Size: =10
            Text: ="Validating process - " & _selectedProcess.Name
            Width: =Parent.Width - Self.X
            X: =Image4.X + Image4.Width + 4
            ZIndex: =2

        btnPublish As button:
            BorderColor: =RGBA(0, 0, 0, 0)
            DisabledBorderColor: =RGBA(0, 0, 0, 0)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            DisplayMode: =If(isPublishReady && Sum(_validationChecks, Status) = 4, DisplayMode.Edit, DisplayMode.Disabled)
            Fill: =RGBA(105, 121, 126, 1)
            FocusedBorderColor: =ColorFade(Self.Fill, -75%)
            Font: =Font.'Segoe UI'
            FontWeight: =FontWeight.Semibold
            Height: =30
            HoverBorderColor: =RGBA(0, 0, 0, 0)
            HoverColor: =RGBA(255, 255, 255, 1)
            HoverFill: =ColorFade(RGBA(105, 121, 126, 1), -10%)
            OnSelect: |
                =With({ 
                    publishedVersions: 
                        SortByColumns(
                            Filter('Business Approval Versions', Process.'Business Approval Process' = _selectedProcess.'Business Approval Process'),
                            "cat_version", SortOrder.Descending
                        )
                    },
                    UpdateContext({ lastPublished: First(publishedVersions) })
                );
                UpdateContext({ busyMessage: "Publishing Process " & _selectedProcess.Name, busyPublish: true });
                
                Patch(
                    'Business Approval Versions', 
                    Defaults('Business Approval Versions'), 
                    { 
                        Process: _selectedProcess, Name: _selectedProcess.Name,
                        Version: If(IsBlank(lastPublished), 1, lastPublished.Version + 1),
                        'Business Owner': _selectedProcess.'Business Owner', 'Business Owner Email': _selectedProcess.'Business Owner Email',
                        'Secondary Owner': _selectedProcess.'Secondary Owner', 'Secondary Owner Email': _selectedProcess.'Secondary Owner Email',
                        'Default Approver': _selectedProcess.'Default Approver', Category: _selectedProcess.Category,
                        'Publishing Status': 'Business Approval Publishing Status'.Pending,
                        'Activate On Publish': 
                            If(tggActivate.Value, 'Activate On Publish (Business Approval Versions)'.Yes, 'Activate On Publish (Business Approval Versions)'.No)
                    }
                );
                
                Navigate(scrProcessVersion);
                UpdateContext({ busyPublish: false })
            PressedBorderColor: =ColorFade(RGBA(105, 121, 126, 1), -50%)
            PressedColor: =RGBA(255, 255, 255, 1)
            PressedFill: =ColorFade(RGBA(105, 121, 126, 1), -30%)
            RadiusBottomLeft: =0
            RadiusBottomRight: =0
            RadiusTopLeft: =0
            RadiusTopRight: =0
            Size: =10
            Text: ="Publish"
            Width: =120
            X: =20
            Y: =Parent.Height - Self.Height - 20
            ZIndex: =3

        lblPublishedVersionInfo As label:
            AutoHeight: =true
            BorderColor: =RGBA(0, 0, 0, 0)
            BorderStyle: =BorderStyle.None
            BorderThickness: =2
            Color: =RGBA(51, 51, 51, 1)
            DisabledBorderColor: =RGBA(0, 0, 0, 0)
            DisabledColor: =RGBA(166, 166, 166, 1)
            FocusedBorderThickness: =4
            Font: =Font.'Segoe UI'
            Size: =10
            Text: |-
                =If(IsBlank(lastPublished), 
                    "This is the first time this process is being published.", 
                    "Last version: " & lastPublished.Version & ", published on: " & Text(lastPublished.'Created On', "dd mmm yyyy hh:mm AM/PM") & 
                    ". Publishing new version: " & lastPublished.Version + 1
                )
            Visible: =btnPublish.DisplayMode = DisplayMode.Edit
            Width: =Parent.Width - Self.X - 20
            X: =btnPublish.X + btnPublish.Width + 20
            Y: =btnPublish.Y
            ZIndex: =4

        lblActivateOnPublish As label:
            BorderColor: =RGBA(0, 0, 0, 0)
            BorderStyle: =BorderStyle.None
            BorderThickness: =2
            Color: =RGBA(51, 51, 51, 1)
            DisabledBorderColor: =RGBA(0, 0, 0, 0)
            DisabledColor: =RGBA(166, 166, 166, 1)
            FocusedBorderThickness: =4
            Font: =Font.'Segoe UI'
            Height: =30
            Size: =10
            Text: |-
                ="Activate process when published: "
            Visible: =btnPublish.DisplayMode = DisplayMode.Edit
            Width: =215
            X: =btnPublish.X
            Y: =btnPublish.Y - Self.Height - 80
            ZIndex: =5

        tggActivate As toggleSwitch:
            BorderColor: =RGBA(0, 0, 0, 0)
            BorderStyle: =BorderStyle.None
            Color: =RGBA(51, 51, 51, 1)
            Default: =true
            DisabledBorderColor: =RGBA(0, 0, 0, 0)
            FalseFill: =RGBA(102, 102, 102, 1)
            FalseHoverFill: =RGBA(33, 33, 33, 1)
            FalseText: ="No"
            FocusedBorderThickness: =4
            Font: =Font.'Segoe UI'
            HandleFill: =RGBA(255, 255, 255, 1)
            Height: =30
            HoverBorderColor: =RGBA(0, 0, 0, 0)
            PressedBorderColor: =RGBA(0, 0, 0, 0)
            Size: =10
            TrueFill: =RGBA(105, 121, 126, 1)
            TrueHoverFill: =ColorFade(RGBA(105, 121, 126, 1), -30%)
            TrueText: ="Yes"
            Visible: =btnPublish.DisplayMode = DisplayMode.Edit
            Width: =90
            X: =lblActivateOnPublish.X + lblActivateOnPublish.Width + 5
            Y: =lblActivateOnPublish.Y + lblActivateOnPublish.Height / 2 - Self.Height / 2
            ZIndex: =6

        Label9 As label:
            AutoHeight: =true
            BorderColor: =RGBA(0, 0, 0, 0)
            BorderStyle: =BorderStyle.None
            BorderThickness: =2
            Color: =RGBA(51, 51, 51, 1)
            DisabledBorderColor: =RGBA(0, 0, 0, 0)
            DisabledColor: =RGBA(166, 166, 166, 1)
            FocusedBorderThickness: =4
            Font: =Font.'Segoe UI'
            Height: =45
            Size: =10
            Text: ="Activating this version will automatically de-activate all previous versions if exist. De-activated processes will continue to run but will not be available for new workflow instances."
            Visible: =btnPublish.DisplayMode = DisplayMode.Edit
            Width: =2 * (Parent.Width / 3)
            X: =btnPublish.X
            Y: =lblActivateOnPublish.Y + lblActivateOnPublish.Height + 5
            ZIndex: =7

        busyPublish As BusyScreen:
            BusyMessage: =busyMessage
            Fill: =RGBA(255, 255, 255, 0.8)
            Height: =Parent.Height
            Visible: =false
            Width: =Parent.Width
            ZIndex: =8

        Image4 As image:
            BorderColor: =RGBA(0, 0, 0, 0)
            BorderStyle: =BorderStyle.None
            BorderThickness: =2
            DisabledBorderColor: =RGBA(0, 0, 0, 0)
            DisabledFill: =RGBA(0, 0, 0, 0)
            FocusedBorderThickness: =4
            Height: =30
            HoverBorderColor: =RGBA(0, 0, 0, 0)
            HoverFill: =RGBA(0, 0, 0, 0)
            Image: ='25_black'
            PressedBorderColor: =RGBA(0, 0, 0, 0)
            PressedFill: =RGBA(0, 0, 0, 0)
            Visible: =!isPublishReady
            Width: =30
            X: =10
            Y: =5
            ZIndex: =9

        "Progress1 As 'Progress Bar'":
            BasePaletteColor: =
            DisplayMode: =DisplayMode.Edit
            Height: =45
            Indeterminate: =true
            ProgressColor: ='Progress.ProgressColor'.Brand
            Visible: =!isPublishReady
            Width: =Parent.Width
            X: =0
            Y: =252
            ZIndex: =10

