scrWorkflowEditor As screen:
    LoadingSpinnerColor: =RGBA(0, 120, 212, 1)
    OnVisible: =Reset(ApprovalDesignerEdit)

    Container1 As groupContainer.verticalAutoLayoutContainer:
        Height: =App.Height
        LayoutAlignItems: =LayoutAlignItems.Stretch
        LayoutDirection: =LayoutDirection.Vertical
        LayoutMode: =LayoutMode.Auto
        Width: =App.Width
        ZIndex: =3

        "CommandBar1 As 'Fluent Command Bar (1.1.29)'.pcfdataset":
            DisplayMode: =DisplayMode.Edit
            Height: =40
            Items: |-
                =Table(
                    {
                        ItemKey: "new",
                        ItemDisplayName: "New Stage",
                        ItemIconName: "Add"
                    },{
                        ItemKey: "process",
                        ItemDisplayName: "Process",
                        ItemIconName: "Flowchart"
                    },{
                        ItemKey: "versions",
                        ItemDisplayName: "Versions",
                        ItemIconName: "DependencyAdd"
                    },{
                        ItemKey: "publish",
                        ItemDisplayName: "Publish",
                        ItemIconName: "PublishContent"
                    }
                )
            LayoutMinHeight: =200
            LayoutMinWidth: =200
            OnSelect: |-
                =Switch(Self.Selected.ItemKey,
                    "new", 
                        Set(_selectedStage, Blank()); 
                        Set(_currentStageIndex, ApprovalDesignerEdit.TotalStages + 1);
                        Navigate(scrStageEditor),
                    "process", Navigate(scrProcessEditor),
                    "versions", Navigate(scrProcessVersion),
                    "publish", Navigate(scrPublishProcess)
                )
            Theme: =AppThemeJson
            Width: =200
            X: =0
            Y: =155
            ZIndex: =1

        bcProcess As label:
            BorderColor: =RGBA(0, 0, 0, 0)
            BorderStyle: =BorderStyle.None
            BorderThickness: =2
            Color: =RGBA(51, 51, 51, 1)
            DisabledBorderColor: =RGBA(0, 0, 0, 0)
            DisabledColor: =RGBA(166, 166, 166, 1)
            FocusedBorderThickness: =4
            Font: =Font.'Segoe UI'
            FontWeight: =FontWeight.Semibold
            Height: =30
            Size: =10
            Text: =_selectedProcess.Name
            Width: =Parent.Width - Self.X - 20
            Wrap: =false
            X: =20
            Y: =
            ZIndex: =2

        lblNoStage As label:
            BorderColor: =RGBA(0, 0, 0, 0)
            BorderStyle: =BorderStyle.None
            BorderThickness: =2
            Color: =RGBA(51, 51, 51, 1)
            DisabledBorderColor: =RGBA(0, 0, 0, 0)
            DisabledColor: =RGBA(166, 166, 166, 1)
            FocusedBorderThickness: =4
            Font: =Font.'Segoe UI'
            Height: =30
            PaddingLeft: =12
            Size: =10
            Text: ="No Approval Stage defined. Click 'New Stage' to configure your first Approval stage."
            Visible: =ApprovalDesignerEdit.TotalStages = 0
            Width: =bcProcess.Width
            Wrap: =false
            X: =bcProcess.X
            Y: =bcProcess.Y + bcProcess.Height
            ZIndex: =3

        ApprovalDesignerEdit As ApprovalDesigner:
            AddNode: |-
                =Set(_selectedNode, Blank());
                Set(_selectedStage, LookUp('Business Approval Stages', 'Business Approval Stage' = GUID(StageId)));
                Set(_currentStageIndex, StageIndex);
                Set(_currentNodeIndex, Row);
                Set(_currentPathIndex, Path);
                Navigate(scrNodeEditor)
            AddStage: ="Text"
            EditNode: |
                =Concurrent(
                    Set(_selectedNode, LookUp('Business Approval Nodes', 'Business Approval Node' = GUID(NodeId))),
                    Set(_selectedStage, LookUp('Business Approval Stages', 'Business Approval Stage' = GUID(StageId)))
                );
                Set(_currentNodeIndex, _selectedNode.'Row Index');
                Set(_currentPathIndex, _selectedNode.'Path Index');
                Set(_currentStageIndex, _selectedStage.Order);
                If(_selectedNode.'Node Condition' = 'Business Approval Stage Condition'.None && IsBlank(_selectedNode.'Go To Stage'),
                    Navigate(scrNodeEditor),
                    Navigate(scrNodeRule)
                )
            EditStage: |-
                =Set(_selectedStage, LookUp('Business Approval Stages', 'Business Approval Stage' = GUID(StageId)));
                Set(_currentStageIndex, _selectedStage.Order);
                Navigate(scrStageEditor)
            FillPortions: =1
            Height: =Parent.Height - Self.Y
            LayoutMinHeight: =640
            LayoutMinWidth: =640
            MoveStage: |-
                =With({ currentStage: LookUp('Business Approval Stages', 'Business Approval Stage' = GUID(StageId))},
                    UpdateContext({ swapOrder: If(IsMoveUp, currentStage.Order - 1, currentStage.Order + 1)});
                    UpdateIf('Business Approval Stages', 
                        Order = swapOrder && Process.'Business Approval Process' = currentStage.Process.'Business Approval Process', 
                        { Order: currentStage.Order }
                    );
                    Patch('Business Approval Stages', currentStage, { Order: If(IsMoveUp, currentStage.Order - 1, currentStage.Order + 1) }) 
                )
            Width: =Parent.Width - 10
            Y: =70
            ZIndex: =4

